# Проект: QRkot-spreadsheets - Благотворительный фонд поддержки котиков с формированием отчётов в Google Sheets

Асинхронный REST API сервис для управления благотворительными проектами и пожертвованиями в поддержку котиков 
с системой аутентификации пользователей и разграничением прав доступа и возможностью формирования отчётов в Google Sheets.

## Технологический стек
- Python 3.12
- FastAPI
- FastAPI Users
- SQLAlchemy
- Pydantic
- Alembic
- SQLite 3.45.3
- JWT
- Google Sheets API
- Aiogoogle

## Функциональность
API предоставляет следующие возможности:

### 1. Управление пользователями
- Регистрация новых пользователей
- Аутентификация через JWT токены
- Просмотр и обновление профиля
- Автоматическое создание первого суперпользователя

### 2. Управление благотворительными проектами
- **Все пользователи**: просмотр списка проектов
- **Только суперпользователи**: создание, редактирование, удаление проектов
- Автоматическое закрытие проектов при достижении цели
- Валидация: нельзя редактировать закрытые проекты или устанавливать сумму меньше собранной

### 3. Управление пожертвованиями
- **Все пользователи**: создание пожертвований (требуется авторизация)
- **Обычные пользователи**: просмотр только своих пожертвований (4 поля)
- **Суперпользователи**: просмотр всех пожертвований (все поля)
- Автоматическое распределение средств между открытыми проектами

### 4. Безопасность и права доступа
- Bearer JWT токены для аутентификации
- Защита эндпоинтов в зависимости от роли пользователя
- Валидация паролей (минимум 3 символа, нельзя использовать email в пароле)

### 5. Генерация отчётов в Google Sheets
- **Суперпользователи**: создание отчётов по закрытым проектам
- Автоматическая сортировка проектов по скорости сбора средств
- Интеграция с Google Sheets API
- Автоматическое обновление данных в существующей таблице

## Бизнес-логика
- Автоматическое распределение пожертвований (первый созданный проект получает средства первым)
- Валидация целевых сумм (нельзя установить сумму меньше уже собранной)
- Защита от редактирования/удаления закрытых проектов и проектов с инвестициями
- Автоматическая сортировка проектов в отчёте по скорости сбора средств

## Ограничения
1) Нельзя удалять пользователей
2) Нельзя редактировать или удалять пожертвования
3) Нельзя редактировать или удалять закрытые проекты
4) Нельзя удалять проекты, в которые инвестированы средства
5) Нельзя изменять даты создания и закрытия проектов
6) Нельзя устанавливать full_amount меньше уже внесенной суммы

## Установка и запуск

### 1. Клонирование репозитория
```bash
git clone https://github.com/Av4irenkin/QRkot-spreadsheets.git
```

### 2. Создание и активация виртуального окружения
```bash
cd QRkot-spreadsheets
python -m venv venv
source venv\Scripts\activate
```

### 3. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 4. Настройка базы данных
- Создайте файл .env в корне проекта:
```
DATABASE_URL=sqlite+aiosqlite:///./cat_charity.db
SECRET=secret
FIRST_SUPERUSER_EMAIL=admin@adm.com
FIRST_SUPERUSER_PASSWORD=admin
TYPE=service_account
PROJECT_ID= Ваш_PROJECT_ID
PRIVATE_KEY_ID= Ваш_PRIVATE_KEY_ID
PRIVATE_KEY="Ваш_PRIVATE_KEY"
CLIENT_EMAIL=Ваш_CLIENT_EMAIL
CLIENT_ID=Ваш_CLIENT_ID
AUTH_URI=https://accounts.google.com/o/oauth2/auth
TOKEN_URI=https://oauth2.googleapis.com/token
AUTH_PROVIDER_X509_CERT_URL=https://www.googleapis.com/oauth2/v1/certs
CLIENT_X509_CERT_URL=Ваш_CLIENT_X509_CERT_URL
EMAIL=Ваш_EMAIL
SPREADSHEET_ID=id_вашей_гугл_таблицы
```
- Примените миграции:
```bash
alembic upgrade head
```

### 5. Настройка Google Sheets
1) Создайте сервисный аккаунт в Google Cloud Console
2) Включите Google Sheets API и Google Drive API
3) Скачайте JSON-ключ и скопируйте данные в .env
4) Создайте Google таблицу вручную через браузер
5) Скопируйте ID таблицы из URL и укажите его в .env
6) Выдайте доступ к таблице сервисному аккаунту (права редактора)

### 6. Запуск приложения
```bash
uvicorn app.main:app --reload
```
- Приложение будет доступно по адресу: [http://127.0.0.1:8000](http://127.0.0.1:8000)

## Эндпоинты

### Аутентификация
- POST /auth/register - Регистрация нового пользователя
- POST /auth/jwt/login - Вход и получение JWT токена
- POST /auth/jwt/logout - Выход (аннулирование токена)

### Пользователи
- GET /users/me - Получить информацию о текущем пользователе
- PATCH /users/me - Обновить информацию текущего пользователя
- GET /users/{id} - Получить информацию о пользователе (только для суперпользователей)
- PATCH /users/{id} - Обновить информацию пользователя (только для суперпользователей)

### Проекты
- GET /charity_project/ - Получить все проекты (доступно всем)
- POST /charity_project/ - Создать новый проект (только для суперпользователей)
- PATCH /charity_project/{project_id} - Обновить проект (только для суперпользователей)
- DELETE /charity_project/{project_id} - Удалить проект (только для суперпользователей)

### Пожертвования
- GET /donation/ - Получить все пожертвования (только для суперпользователей)
- POST /donation/ - Создать пожертвование (требуется авторизация)
- GET /donation/my - Получить мои пожертвования (требуется авторизация)

### Google Sheets
- POST /google/create_report - Создать отчёт по закрытым проектам (только для суперпользователей)

### Документация API
- [Swagger](http://127.0.0.1:8000/docs)
- [ReDoc](http://127.0.0.1:8000/redoc)


## Автор
[Иван Овчаренко](https://github.com/Av4irenkin)
[Av4rnk@gmail.com](Av4rnk@gmail.com)